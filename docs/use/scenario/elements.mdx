
# シナリオを構成している要素 {#scenario-content}

Scenamatica のシナリオを構成する要素について説明しています。

---

## 概要 {#about}

シナリオは、以下の要素で構成されています。

+ 名前
+ 説明
+ [トリガ](#trigger)
+ [コンテキスト](#context)
+ 本[シナリオ](#scenario)

:::info

本[シナリオ](#scenario)は、プラグインの機能を検証する主要な[シナリオ](#scenario)のことです。

:::

## シナリオ {#scenario}

:::caution


Scenamatica で使用される「シナリオ」という語は、以下の２つの意味を持ちます。

1. [コンテキスト](#context) や [トリガー](#trigger) などの概念を含む、包括的な意味でのシナリオ。
2. [シナリオファイル](#scenario-file) に記述された、プラグインの振る舞いを検証するための一連のアクションのこと。

この項目では、後者の意味での「シナリオ」について説明しています（このページ全体では、前者のシナリオの要素について説明しています）。
:::

シナリオは、プラグインの代表的な I/O を定義したものです。
Scenamatica は、これを一つ一つ実行/検証 し、プラグインの振る舞いを検証します。
実行/検証に失敗した場合、 Scenamatica はプラグインが正しく動作していないと判断し、エラーを報告します。

### シナリオタイプ {#scenario-type}

シナリオタイプは、そのシナリオの振る舞いを決めて検証事項を定義するものです。
シナリオタイプによって、シナリオの成功条件や失敗条件が異なります。

:::tip

各シナリオは、[シナリオタイプ](#scenario-type) と[アクション](#action-concept) および タイムアウト(ms)で構成されています。

:::

### アクション実行(`execute`) タイプ {#scenario-type-action-execution}

アクション実行(`execute`) タイプは、引数に指定されたアクションを実行し、完了するまでまたはタイムアウトまで待機します。

+ シナリオの成功条件
  * アクションが完了する。
+ シナリオの失敗条件
  * アクションがタイムアウトする。
  * アクションの実行時に例外またはエラーが発生する。

### アクション実行期待(`expect`) タイプ {#scenario-type-action-execution-expect}

アクション実行期待(`expect`) タイプは、引数に指定されたアクションがプラグインによって実行されるか検証します。
アクションが起きるまでまたはタイムアウトまで待機します。

後に実行されるべきアクションが繰り上げられて先に実行された場合、このシナリオは失敗します。

例えば、以下のようなシナリオがあったとします：

+ アクション A を実行する
+ アクション B の実行を期待する （プラグインによって実行されるか）
+ アクション C を実行を期待する （プラグインによって実行されるか）

このとき、プラグインによって A -> C -> B の順番で実行された場合、このシナリオは C の実行とともに失敗します。

:::caution

失敗になるのはアクションの実行順序がおかしい場合のみです。

例えば「指定されたメッセージが送信されるか期待する」シナリオで、指定されたものと違うメッセージが送信された場合でも、即座に失敗になることはありません。
そのあとに正しいメッセージが時間内に送信された場合、このシナリオは成功します。

:::

+ シナリオの成功条件
  * 対象のプラグインによってアクションが実行される。
+ シナリオの失敗条件
  * 検証がタイムアウトする。
  * 他のアクションが先に実行される。

### コンディション要求(`require`) タイプ {#scenario-type-condition-require}

コンディション要求(`require`) タイプは、引数に指定されたコンディションが**既に**満たされているか検証します。

:::caution

このタイプは、そのシナリオに到達する前にコンディションを満たしていることを確認するためのものです。

そのため、満たされるまで待機したり、タイムアウトまで待機する機能はありません。

:::

+ シナリオの成功条件
  * コンディションが満たされている。
+ シナリオの失敗条件
  * （このシナリオに到達時に）コンディションが満たされていない。

## トリガ {#trigger}

トリガは、[シナリオ](#scenario) の実行を開始するための条件です。
通常シナリオは複数のトリガを持ちます。
そのうちのどれかのトリガが発火すると、シナリオが開始されます。

### 事前/事後シナリオ機能 {#before-after-scenarios}

前述の通り、１つのシナリオは複数のトリガを持つことができます。
ですが、特定のトリガによって実行されたシナリオの前に他のシナリオを実行したり、後に他のシナリオを実行したい場合があります。

この機能は、このような要求を実現するために用意されています。
