import Action, {ScenarioType} from "/src/components/Action";
import BelowDocument from "/src/components/BelowDocument";
import {ObjectType} from "/src/components/Object";

# エンティティに関連するアクション

エンティティに関連するアクションを列挙しています。

---

## 記述する際の注意 {#notes}

:::tip

**シナリオやシナリオファイルの概念が初めての方は、先に[こちら](/docs/use/scenario)を参照して理解しておくことを推奨します。**

:::

<BelowDocument docId="use/scenario/scenario-file"
               label="シナリオファイルを記述する際の注意"
               anchor="notes"
/>

## 全般 - 引数 `target` {#general-target}

対象のエンティティを[EntitySpecifier 型（エンティティ指定子）](/docs/use/scenario/types/entities#entity-specifier)で指定します。

:::warning

セレクタを [Entity 型](/docs/use/scenario/types/entities#entity-structure) のオブジェクトを指定する場合、
捜索範囲はシナリオの[ステージ](/docs/use/scenario/elements#stage)内かつ、ロードされているチャンクに限定されます。

:::

:::tip

[エンティティ（コンテキスト）](/docs/use/scenario/elements/entities#entity)を使用すれば、常に読み込まれるシナリオ専用のエンティティを作成できます。

:::

:::info シナリオの種類での振る舞いの違い

+ アクション実行シナリオでは、単一のエンティティを指します。  
  `@e` 等で複数のエンティティを指定した場合、最初に見つかったエンティティが使用されます。
+ アクション実行期待シナリオでは、該当する**複数のエンティティのどれか**を指します。  
  複数のエンティティを指定した（が見つかった）場合、そのうちのどれか一体が条件を満たしていたらパスされます。  
  単一のエンティティを指定した場合はそのエンティティが条件を満たしているかどうかが判定されます。

例：
``` yaml

- type: execute
  action: entity_...
  with:
    targe: "@e[team=Red]"  # チームが Red のエンティティのうち、最初に見つかったものが使用される

---

- type: expect
  action: entity_...
  with:
    target: "@e[team=Red]"  # チームが Red のエンティティのうち、どれか一体が条件を満たしていればパスされる

```

:::

## 特別：エンティティ {#entity}

<Action name="エンティティ"
        description="エンティティの状態や振る舞い、属性を変更します。"
        id="entity"
        args={[
          {
            name: "target",
            type: "EntitySpecifier",
            anchor: "general-target",
            type_link: "/docs/use/scenario/types/entities#entity-specifier",
            description: "状態を書き換える対象のエンティティです。",
            required: true
          },
          {
            name: "entity",
            anchor: "entity-entity",
            type: "Entity",
            type_link: "/docs/use/scenario/types#entity-structure",
            description: "書き換えるエンティティの状態です。",
            required: [ScenarioType.EXECUTE]
          },
        ]}
        executable requireable
/>

条件要求シナリオで使用すると、エンティティの属性や状態（例：体力、位置、速度など）を確認できます。

## ダメージ {#damage}

<Action name="エンティティのダメージ"
        description="エンティティにダメージを与えます。"
        id="entity_damage"
        events={[
          {
            name: "EntityDamageEvent",
            package: "org.bukkit.event.entity",
          }
        ]}
        args={[
          {
            name: "target",
            type: "EntitySpecifier",
            anchor: "general-target",
            type_link: "/docs/use/scenario/types/entities#entity-specifier",
            description: "ダメージを与える対象のエンティティです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "amount",
            anchor: "damage-amount",
            type: ObjectType.FLOAT,
            description: "ダメージの量です。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "cause",
            type: "EntityDamageCause",
            type_anchor: "damage-enum-entity-damage-cause",
            description: "ダメージの種類です。",
            required: [ScenarioType.EXPECT],
            available: [ScenarioType.EXECUTE]
          },
          {
            name: "modifiers",
            anchor: "damage-modifiers",
            type: ObjectType.OBJECT,
            description: "ダメージの Modifier です。",
            available: [ScenarioType.EXPECT]
          }
        ]}
        executable watchable
/>

#### `amount` {#damage-amount}

いわゆる `EntityDamageEvent#getFinalDamage()` に相当します。

:::caution

アクション実行シナリオでは必須です。

:::

#### `modifiers` {#damage-modifiers}

ダメージを計算するときに加味するべき重みをオブジェクトで指定します。  
キーには以下の値を、値には重みを倍精度浮動小数点数 (`double`) で指定します。

+ `BASE` 基本のダメージ。 `amount` で指定した値が使用されます。
+ `HARD_HAT` ヘルメットなどによる防御
+ `BLOCKING` シールドによる防御
+ `ARMOR` 防具による防御
+ `RESISTANCE` エンチャント「耐性」による防御
+ `MAGIC` ウィッチのポーション効果や防具のエンチャントによる防御
+ `ABSORPTION` エンチャント「ダメージ軽減」による防御

#### `EntityDamageCause` {#damage-enum-entity-damage-cause}

ダメージの種類を指定します。以下の値が有効です：

+ `CONTACT` エンティティ同士の接触
+ `ENTITY_ATTACK` エンティティによる攻撃
+ `ENTITY_SWEEP_ATTACK` エンティティによる攻撃（範囲攻撃）
+ `PROJECTILE` 射撃
+ `SUFFOCATION` ブロックへのめり込み 
+ `FALL` 落下
+ `FIRE` 炎
+ `FIRE_TICK` 炎の延焼
+ `MELTING` スノーゴーレムの溶解
+ `LAVA` 溶岩
+ `DROWNING` 溺れ
+ `BLOCK_EXPLOSION` 爆発
+ `ENTITY_EXPLOSION` エンティティの爆発
+ `VOID` 奈落への落下
+ `LIGHTNING` 雷
+ `SUICIDE` `/kill` コマンドによる自殺
+ `STARVATION` 飢餓
+ `POTION` ポーション効果
+ `MAGIC` 魔法
+ `WITHER` ウィザーの効果
+ `FALLING_BLOCK` 金床などの落下するブロック
+ `THORNS` エンチャント「棘」によるカウンター
+ `DRAGON_BREATH` エンダードラゴンのドラゴンブレス
+ `CUSTOM` カスタムダメージ
+ `FLY_INTO_WALL` エリトラなどによる壁への衝突
+ `HOT_FLOOR` マグマブロックなどの熱いブロック
+ `CRAMMING` エンティティの密集
+ `DRYOUT` 乾燥

## エンティティによるダメージ {#damage-by-entity}

<Action name="エンティティによるダメージ"
        description="エンティティによるダメージをエンティティに与えます。"
        id="entity_damage_by_entity"
        events={[
          {
            name: "EntityDamageByEntityEvent",
            package: "org.bukkit.event.entity",
          }
        ]}
        args={[
          {
            name: "target",
            type: "EntitySpecifier",
            anchor: "general-target",
            type_link: "/docs/use/scenario/types/entities#entity-specifier",
            description: "ダメージを受けるエンティティです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "damager",
            type: ObjectType.STRING,
            anchor: "general-target",
            type_link: "/docs/use/scenario/types/entities#entity-specifier",
            description: "ダメージ元のエンティティです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "cause",
            type: "EntityDamageEvent",
            type_anchor: "damage-enum-entity-damage-cause",
            description: "ダメージの種類です。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "amount",
            anchor: "damage-amount",
            type: ObjectType.FLOAT,
            description: "ダメージの量です。",
            required: [ScenarioType.EXECUTE, ScenarioType.EXPECT]
          },
          {
            name: "modifiers",
            anchor: "damage-modifiers",
            type: ObjectType.OBJECT,
            description: "ダメージの Modifier です。",
            available: [ScenarioType.EXPECT]
          }
        ]}
        executable watchable 
/>

:::info

このアクションは[エンティティのダメージ](#damage) をベースにしており、内部のロジックもほとんど同じです。  

:::

## 死亡 {#death}

<Action name="エンティティの死亡"
        description="エンティティを死亡させます。"
        id="entity_death"
        events={[
          {
            name: "EntityDeathEvent",
            package: "org.bukkit.event.entity",
          }
        ]}
        args={[
          {
            name: "target",
            type: "EntitySpecifier",
            anchor: "general-target",
            type_link: "/docs/use/scenario/types/entities#entity-specifier",
            description: "死亡させるエンティティです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "drops",
            type: "ItemStack[]",          
            type_link: "/docs/use/scenario/types#item-stack-structure",
            description: "ドロップするアイテムです。",
            available: [ScenarioType.EXPECT]
          },
          {
            name: "dropExp",
            type: ObjectType.INTEGER,
            description: "ドロップする経験値です。",
            available: [ScenarioType.EXPECT]
          },
          {
            name: "reviveHealth",
            type: ObjectType.INTEGER,
            description: "復活時の体力です。",
            available: [ScenarioType.EXPECT]
          },
          {
            name: "playDeathSound",
            type: ObjectType.BOOLEAN,
            description: "死亡時のサウンドを再生するかどうかです。",
            available: [ScenarioType.EXPECT]
          },
          {
            name: "sound",
            type: "Sound",
            description: "再生するサウンドです。",
            available: [ScenarioType.EXPECT]
          },
          {
            name: "soundCategory",
            type: "SoundCategory",
            description: "サウンドのカテゴリです。",
            available: [ScenarioType.EXPECT]
          },
          {
            name: "soundVolume",
            type: ObjectType.FLOAT,
            description: "サウンドの音量です。",
            available: [ScenarioType.EXPECT]
          },
          {
            name: "soundPitch",
            type: ObjectType.FLOAT,
            description: "サウンドのピッチです。",
            available: [ScenarioType.EXPECT]
          }
        ]}
        executable watchable
/>

:::caution 

アクション実行シナリオにおいて, `target` はエンティティのオブジェクトである必要があります。セレクタは指定できません。
これは, Bukkit が死亡したエンティティを即座に削除し, 追跡不能にするためです。

:::

## エンティティによるアイテムのドロップ {#drop-item}

<Action name="エンティティによるアイテムのドロップ"
        description="エンティティによるアイテムのドロップを設定します。"
        id="entity_drop_item"
        events={[
          {
            name: "EntityDropItemEvent",
            package: "org.bukkit.event.entity",
          }
        ]}
        args={[
          {
            name: "entity",
            anchor: "general-target",
            type_link: "/docs/use/scenario/types/entities#entity-specifier",
            type: ObjectType.STRING,
            description: "アイテムをドロップするエンティティです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "item",
            type: "EntityItem",
            type_link: "/docs/use/scenario/types#entity-item-structure",
            description: "ドロップするアイテムです。",
            required: [ScenarioType.EXECUTE]
          }
        ]}
        executable watchable
/>

## 移動 {#move}

<Action name="エンティティの移動"
        description="エンティティを移動させます。"
        id="entity_move"
        events={[
          {
            name: "EntityMoveEvent",
            package: "org.bukkit.event.entity",
          }
        ]}
        args={[
          {
            name: "entity",
            anchor: "general-target",
            type_link: "/docs/use/scenario/types/entities#entity-specifier",
            type: ObjectType.STRING,
            description: "移動させるエンティティです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "from",
            type: "Location",
            type_link: "/docs/use/scenario/types/misc#location-structure",
            description: "移動前の位置です。",
            available: [ScenarioType.EXPECT]
          },
          {
            name: "to",
            type: "Location",
            type_link: "/docs/use/scenario/types/misc#location-structure",
            description: "移動後の位置です。",
            required: [ScenarioType.EXECUTE, ScenarioType.EXPECT]
          },
          {
            name: "ai",
            type: ObjectType.BOOLEAN,
            description: "AI を有効にするかどうかです。",
            available: [ScenarioType.EXECUTE],
            anchor: "move-ai",
            default: true
          }
        ]}
        executable watchable
/>

:::tip

アクション実行期待シナリオにおける座標の比較は、誤差 `0.01` まで許容されます。

:::

#### `ai` {#move-ai}

AI を有効にした場合, エンティティは経路を探索し自発的に移動しようとします。  
経路が見つからなかった場合や, その場所に到達できない場合は例外をスローし, シナリオの実行が**失敗します**。

この引数を `false` にした場合, エンティティは移動先にテレポートします。

## アイテムのピックアップ {#pickup-item}

<Action name="アイテムのピックアップ"
        description="エンティティがアイテムをピックアップします。"
        id="entity_pickup_item"
        events={[
          {
            name: "EntityPickupItemEvent",
            package: "org.bukkit.event.entity",
          }
        ]}
        args={[
          {
            name: "entity",
            anchor: "general-target",
            type_link: "/docs/use/scenario/types/entities#entity-specifier",
            type: ObjectType.STRING,
            description: "アイテムをピックアップするエンティティです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "item",
            type: "EntityItem | " + ObjectType.STRING,
            type_link: "/docs/use/scenario/types#entity-item-structure",
            description: "ピックアップするアイテムです。",
            anchor: "pickup-item-item",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "remaining",
            type: ObjectType.INTEGER,
            description: "残りのアイテムの数です。",
            available: [ScenarioType.EXPECT]
          }
        ]}
        executable watchable
/>

#### アクション実行シナリオでの使用 {#pickup-item-execute}

アイテムを拾うエンティティは, [LivingEntity](https://jd.papermc.io/paper/1.16/org/bukkit/entity/LivingEntity.html) かつ, 
アイテムを拾える状態（[LivingEntity#canPickupItems()](https://jd.papermc.io/paper/1.16/org/bukkit/entity/LivingEntity.html#canPickupItems()) が `true`）である必要があります。

さらに, アイテムが以下の状態である必要があります。
+ 拾うエンティティがモブの場合, [Item#canMobPickup()](https://jd.papermc.io/paper/1.16/org/bukkit/entity/Item.html#canMobPickup()) が `true` であること。
+ 拾うエンティティがプレイヤの場合, [Item#canPlayerPickup()](https://jd.papermc.io/paper/1.16/org/bukkit/entity/Item.html#canPlayerPickup()) が `true` であること。

プレイヤがアイテムを拾った場合, そのアイテムはプレイヤのインベントリに移動されます。

#### `item` {#pickup-item-item}

アクション実行シナリオの場合でも, [アイテムの構造体](/docs/use/scenario/types#entity-item-structure)またはエンティティのセレクタを指定できます。
アイテムの構造体を指定した場合, 事前にそのアイテムをワールドにスポーンさせます。


## 設置 {#place}

<Action name="エンティティの設置"
        description="エンティティを設置します。"
        id="entity_place"
        events={[
          {
            name: "EntityPlaceEvent",
            package: "org.bukkit.event.entity",
          }
        ]}
        args={[
          {
            name: "entity",
            anchor: "place-entity",
            type: "Entity",
            type_link: "/docs/use/scenario/types#entity-structure",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "player",
            type: ObjectType.STRING,
            description: "エンティティを設置するプレイヤーです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "block",
            anchor: "place-block",
            type: "Block",
            type_link: "/docs/use/scenario/types/misc#block-structure",
            description: "エンティティを設置するブロックです。",
            required: [ScenarioType.EXECUTE]
          },
          {
            name: "direction",
            anchor: "place-direction",
            type: "BlockFace{UP, DOWN, NORTH, EAST, SOUTH, WEST}",
            type_link: "/docs/use/scenario/types#block-face-enum",
            description: "エンティティを設置する方向です。",
          }
        ]}
        executable watchable
/>

#### `block` {#place-block}

:::caution 

アクション実行シナリオの場合、この項目および [`Block#location`](/docs/use/scenario/types/misc#location-structure) は必須です。

:::

#### `direction` {#place-direction}

エンティティを設置する方向を指定します。

:::info

アクション実行シナリオで省略した場合、プレイヤの位置と対象の位置から推論されます。

:::

#### `entity` {#place-entity}

アクション実行シナリオの場合、設置するエンティティの UUID やセレクタ、または アイテム化したときの Material を指定します。  
設置できるエンティティは、 Bukkit との相互作用のために以下のものに限られます。
それら以外を設置・召喚する場合は [エンティティのスポーン](#spawn)アクション を使用してください。

+ `MINECART`
+ `CHEST_MINECART`
+ `FURNACE_MINECART`
+ `TNT_MINECART`
+ `HOPPER_MINECART`
+ `COMMAND_BLOCK_MINECART`
+ `ARMOR_STAND`
+ `LEGACY_ARMOR_STAND`
+ `ACACIA_BOAT`
+ `BIRCH_BOAT`
+ `DARK_OAK_BOAT`
+ `JUNGLE_BOAT`
+ `OAK_BOAT`
+ `LEGACY_BOAT`
+ `LEGACY_BOAT_ACACIA`
+ `LEGACY_BOAT_BIRCH`
+ `LEGACY_BOAT_DARK_OAK`
+ `LEGACY_BOAT_JUNGLE`
+ `LEGACY_BOAT_SPRUCE`
+ `SPRUCE_BOAT`
+ `END_CRYSTAL`
+ `LEGACY_END_CRYSTAL`


## スポーン {#spawn}

<Action name="エンティティのスポーン"
        description="エンティティをスポーンさせます。"
        id="entity_spawn"
        events={[
          {
            name: "EntitySpawnEvent",
            package: "org.bukkit.event.entity",
          }
        ]}
        args={[
          {
            name: "entity",
            type: "Entity",
            type_link: "/docs/use/scenario/types#entity-structure",
            description: "スポーンさせるエンティティの構造体です。",
            required: [ScenarioType.EXECUTE]
          }
        ]}
        executable watchable
/>

#### `entity` {#spawn-entity}

エンティティの構造体を指定します。

:::tip

これには、 `Entity` 型のオブジェクトないしはその子のオブジェクトを指定できます。

`Projectile` 型のオブジェクトを指定した場合、 `shooter` 等を設定した状態でスポーンできます。

:::

:::caution

アクション実行シナリオでは, Entity オブジェクトの `type` が必須です。  
また, アクション実行期待シナリオでは, Entity 型の `target` 引数は使用できません。

:::
