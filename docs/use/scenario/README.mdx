import BelowDocument from "/src/components/BelowDocument";

# シナリオ

シナリオの概念とその概要について説明しています。

---

## 概要

シナリオは、プラグインの入出力をフローとして表すための概念です。

プラグインの開発者が代表的な I/O (e.g. メッセージの送信、プレイヤゲームモードの変更...) を予めシナリオとして定義し、
Scenamatica がそれをステップ実行します。
シナリオの実行結果はそのままテスト結果として出力されるため、プラグインの自動テストが実現されます。

シナリオはセッションと呼ばれるシナリオの集合で実行されます。  
セッションに関しては[こちら](#scenario-session)を参照してください。

## シナリオの具体的な構成要素 {#scenario-elements}

<BelowDocument docId="use/scenario/elements"
               label="シナリオを構成する要素"
/>

## シナリオファイルについて {#scenario-file}

Scenamatica のシナリオは シナリオファイルと呼ばれる YAML ファイルで記述します。  
シナリオファイルはプラグインの .jar ファイルの任意の場所に配置します。

<BelowDocument docId="use/scenario/file-syntax"
               label="シナリオファイル"
               message="シナリオファイルの構文については、以下のページを参照してください。" />

## シナリオの記述作業を開発フローに取り込む {#integrating-scenamatica}

シナリオ機能を利用するには、プラグインの機能やテストごとに [シナリオファイル](#scenario-file) を記述する作業が必要です。
なぜなら、Scenamatica は何をしたらあなたのプラグインの機能が実行されるかや、どのような結果が期待されるかを知らないためです。
そのため、プラグインの開発者が、プラグインの正しい動作を Scenamatica に教える必要があります。

シナリオファイルの記述は JUnit のテストコードの記述と同じように、開発フローに取り込めます。
新規機能を追加する際には、その機能を実装する前にシナリオファイルを作成し、それにそって実装を進めるとよいでしょう。

## シナリオセッションについて {#scenario-session}

シナリオセッションは、複数のシナリオをまとめて実行するための機能です。
１つのセッションは複数のシナリオを持ち、自動的に構成されます。
セッションに登録される各シナリオは順番付けされて実行されます。

:::tip

シナリオが同時に発火した場合、同じセッションに登録されます。  
例えば、 シナリオの読み込み後に実行するトリガ (`ON_LOAD`) を持つシナリオが .jar ファイルに複数存在する場合、同じセッションで実行されます。

:::

:::info

シナリオを実行するには、必ずセッションが必要です。  
セッションが存在しない場合、シナリオ実行マネージャは新規セッションを作成します。

:::


### シナリオの実行順序の制御 {#scenario-ordering}

シナリオの実行順序は、シナリオファイルの `order` プロパティによって制御できます。  
デフォルトは `NORMAL`(`0`) です。これを設定しない場合は自動的に名前順でソートされ、セッションの末尾に追加されます。

:::caution 実行順序の制御は**同一セッション内でのみ有効**です。

例えば、以下のようなシナリオとセッション（順不同）を考えます。

- シナリオA - `order: 1`
- シナリオB - `order: 2`
- シナリオC - `order: 3`
- シナリオD - \(未設定)

+ セッション\[0]
  + シナリオD
  + シナリオA
  + シナリオC
+ セッション\[1]
  + シナリオD
  + シナリオB

このとき, シナリオの実行順は `D -> A -> C -> D -> B` となります。
また、シナリオの実行順序はセッションごとに独立しているため、セッション\[0] の中身 => セッション\[1] のシナリオ郡というように実行されます。

:::


## シナリオの実行の状態 {#scenario-status}

Scenamatica のシナリオの実行状況は以下の状態に分類されます。  
シナリオの実行が異常終了した場合、以下の状態一覧を参考にするとエラー原因の特定に役立つでしょう。

+ `STAND_BY`  
  シナリオがコンパイルされ、実行を待機している状態です。
+ `CONTEXT_PREPARING`  
  シナリオの実行に必要なコンテキストを準備している状態です。
+ `STARTING`  
  シナリオエンジンを初期化し起動を待機している状態です。
+ `RUNNING_BEFORE`（オプション）  
  シナリオの実行前に実行されるシナリオを実行している状態です。  
  トリガによっては実行されることがあります。
+ `RUNNING_MAIN`  
  シナリオの実行を行っている状態です。
+ `RUNNING_AFTER`（オプション）
  シナリオの実行後に実行されるシナリオを実行している状態です。  
  トリガによっては実行されることがあります。
+ `CLEANING_UP`  
  シナリオの実行後の後処理を行っている状態です。
+ `FINISHED`  
  シナリオの実行が終了した状態です。


## Scenamaticaの実行フロー {#scenario-flow}

![Flow#550x](images/scenamatica-flow.svg)

### シナリオの実行フロー

![Scenario#550x](images/scenario.svg)
