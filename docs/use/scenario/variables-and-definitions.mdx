---
sidebar_position: 6
---

import BelowDocument from "/src/components/BelowDocument";
import { Object, ObjectType } from "/src/components/Object";

# 変数・定数の定義と参照

このページでは、シナリオの変数や定数の定義、およびその参照方法について説明します。

---

## 概要

[シナリオファイル](/docs/use/scenario/scenario-file#overview)では、定数を定義し、同じファイル内の任意の場所から参照できます。
さらに、シナリオ内で使用できる予約された変数も使用できます。

## 定数の定義と参照 {#constant-definition}

### 概要 {#constant-definition-overview}

定義機能は、シナリオファイルで任意の値の定数を定義し、同じファイルの任意の場所から参照できるようにする機能です。

主に、アクタのインベントリや検証用のメッセージなど、同じ値を複数回使用する場合に使用します。  
これにより、シナリオファイルの冗長な記述を減らし、**可読性と保守性を向上**させます。

定義・参照には以下のの２つの種類があります。
1. **オブジェクトの定義**  
  オブジェクトとは、アクタのインベントリの設定など、 YAML の `キー:値` で表現されるものです。
  参照用のプロパティを使用したいところで記述することで、オブジェクトの値を参照できます。
2. **埋め込み文字列の定義**  
  シナリオファイル内の任意の文字列の一部または全部を、定義を使用して置換します。
  :::warning
  文字列の埋め込み機能は、 YAML のキーでは使用できません。
  :::

### 定義の作成 {#create-constant}
  
定義は、シナリオファイルのルートに `definitions` という名前のオブジェクトを作成し、その中に定義を記述します。  
キーには割り当てる任意の名前を記述し、値には定義したい任意の型の値を記述します。

以下は、定義の例です。

```yaml
scenamatica: 1.0.0

# （中略）

definitions:
  # オブジェクトの定義
  item:
    type: DIAMOND_HOE
    name: "ダイヤのクワ"
    lores:
      - "めちゃつよダイヤのクワ"

  # 埋め込み文字列の定義
  death_message: "死んでしまった！"

```

### 定義されたオブジェクトを参照する {#reference-object-definition}

定義されたオブジェクトは、シナリオファイル内の任意の場所で参照できます。  
`$ref` というキーを任意の場所で定義すると、 `$ref` のある階層に定義が展開されます。

参照元に同じキーのプロパティがある場合は、参照元の値がそのまま使用されます。  
また、 参照時に使用した `$ref` プロパティは実行時に削除されます。

以下は、定義されたオブジェクトを参照する例です。定義は [定義の作成](#create-definition) で作成したものを使用しています。

```yaml
# （中略）

context:
  actors:
    - name: Hoge
      # インベントリの 0, 1, 2 番目のスロットに定義された item を設定
      main:
        0:
          $ref: item
        1:
          $ref: item
        2:
          $ref: item

```

### 埋め込み文字列を参照する {#reference-embedded-string-definition}

埋め込み文字列は、シナリオファイル内の任意の文字列内で使用できます。
任意の文字列内で `${` と `}` で定義の名前を囲んで使用します。

:::tip

`{` と `}` をエスケープする場合は、 `${{}` や `${}}` のように記述します。  
（`{` と `}` という名前の定義が暗黙的に作成されており、参照する形でアクセスします。）

:::

以下は、埋め込み文字列を参照する例です。定義は [定義の作成](#create-definition) で作成したものを使用しています。

```yaml

# （中略）

actions:
  - type: expect
    action: "message"
    with:
      message: "死亡メッセージ：${death_message}"
      recipient: "Hoge"

```

## 予約された変数 {#reserved-variables}

### 概要 {#reserved-variables-overview}

これは、予め定義された任意の値です。
予約されたキーを用いてシナリオ内で参照することで、シナリオの実行時に値が設定されます。

変数はセッションごともしくは実行ごとにリセットされます。

### 変数の参照 {#reserved-variables-reference}

変数を使用するには、リテラルのかわりに使用する変数名を `${` および `}` で囲みます。  
各要素は `.` で区切ってアクセスします。

:::info

値の参照は、それが使われているシナリオないしはそのエンジンの開始前に行われます。

:::

:::tip

型は自動で推論されるため、使用できない型を参照するとエラーになります。   
また、文字列との相互変換や、数値のキャストも自動で行われます。

:::

### 変数の一覧 {#reserved-variables-list}

<Object objects={[
  {
    name: "runtime",
    type: "Runtime",
    type_anchor: "variables-type-runtime",
    description: "Java のランタイム情報を取得します。",
  },
  {
    name: "session",
    type: "Session",
    type_anchor: "variables-type-session",
    description: "現在のシナリオが属しているセッションの情報です。",
  },
  {
    name: "system",
    type: "SystemProperties",
    anchor: "variables-system",
    description: "Java のシステムプロパティを取得します。"
  },
  {
    name: "scenario",
    type: ["Scenario"],
    type_anchor: "variables-type-scenario",
    description: "自身のシナリオを取得します。",
  }
]}/>

#### `system` {#variables-system}

Java の `System#getProperties()Ljava/lang/String;` で取得できるシステムプロパティを取得します。

:::warning

存在しないプロパティを参照するとエラーになります。

:::

#### `runtime` {#variables-type-runtime}

<Object objects={[
  {
    name: "memory",
    type: "Memory",
    type_anchor: "variables-type-runtime-memory",
    description: "マシンのメモリ情報を取得します。",
  }
]} />

#### `runtime`.`memory` {#variables-type-runtime-memory}

<Object objects={[
  {
    name: "total",
    type: ObjectType.LONG,
    description: "マシンのメモリの合計値です。",
  },
  {
    name: "free",
    type: ObjectType.LONG,
    description: "マシンのメモリの空き値です。",
  },
  {
    name: "max",
    type: ObjectType.LONG,
    description: "マシンのメモリの最大値です。",
  }
]} />


#### `session` {#variables-type-session}

<Object objects={[
  {
    name: "started_at",
    type: ObjectType.LONG,
    description: "セッションの開始時刻です。"
  },
  {
    name: "scenarios.*",
    type: [ObjectType.INTEGER, "Scenario"],
    type_anchor: "variables-type-scenario",
    anchor: "variables-type-session-scenarios",
    description: "セッションに属するシナリオの一覧またはその数です。",
  }
]} />

#### `session`.`scenarios`.`*` {#variables-type-session-scenarios}

`*` には、シナリオ（ファイル）の名前を指定します。

#### Scenario {#variables-type-scenario}

この変数を使用してシナリオを取得するには、子に[シナリオの名前](/docs/use/scenario/types/#apex-name)を指定します(MUST)。

また、以下の変数に加えて追加で[シナリオファイル](/docs/use/scenario/scenario-file)におけるすべての値を参照できます。

<Object objects={[
  {
    name: "result",
    type: [ObjectType.BOOLEAN, "ScenarioResult"],
    description: "シナリオの実行結果または成功したかどうかです。",
    anchor: "variables-type-session-scenarios-result"
  },
  {
    name: "started_at",
    type: ObjectType.LONG,
    description: "シナリオの開始時刻です。",
  },
  {
    name: "finished_at",
    type: ObjectType.LONG,
    description: "シナリオの終了時刻です。",
  },
  {
    name: "scenario.*.output",
    type: "Object",
    description: "シナリオの出力です。",
    anchor: "variables-type-session-scenario-output"
  },
  {
    name: "scenario.*.runif.output",
    type: "Object",
    description: "各シナリオの条件の出力です。",
    anchor: "variables-type-session-scenario-runif-output"
  },
  {
    name: "runif.output",
    type: "Object",
    description: "シナリオの条件の出力です。",
  },
  {
    name: "trigger",
    type: "Trigger",
    description: "シナリオを発火させたトリガです。",
    type_anchor: "variables-type-trigger",
  }
]} />

#### `session`.`scenario`.`*`.`output` {#variables-type-session-scenario-result}

`*` には、シナリオのインデックスまたは[名前](/docs/use/scenario/types/#scenario-name)を指定します。

:::tip

これを参照する場合、中間の `scenario` は省略できます。
例： `session.scenario.foo.output` → `session.foo.output`

:::

#### `session`.`scenario`.`*`.`runif`.`output` {#variables-type-session-scenario-runif-output}

`*` には、シナリオのインデックスまたは[名前](/docs/use/scenario/types/#scenario-name)を指定します。

:::tip

これを参照する場合、中間の `scenario` は省略できます。
例： `session.scenario.foo.runif.output` → `session.foo.runif.output`

:::
#### ScenarioResult {#variables-type-scenario-result}

<Object objects={[
  {
    name: "state",
    type: "String(ScenarioState)",
    description: "シナリオの状態です。"
  },
  {
    name: "cause",
    type: "String(ScenarioCause)",
    type_link: "/docs/use/test#test-status-result",
    description: "シナリオの終了理由です。"
  },
  {
    name: "attempt_of",
    type: ObjectType.INTEGER,
    description: "シナリオの試行回数です。"
  }
]} />

#### Trigger {#variables-type-trigger}

以下の変数に加えて追加で[トリガ](/docs/use/scenario/types#trigger-structure)におけるすべての値を参照できます。

<Object objects={[
  {
    name: "runif.output",
    type: "Object",
    description: "トリガの条件付き実行の出力です。"
  },
  {
    name: "before.*.output",
    type: "Object",
    description: "トリガの前シナリオの出力です。"
  },
  {
    name: "after.*.output",
    type: "Object",
    description: "トリガの後シナリオの出力です。"
  },
  {
    name: "output",
    type: "Object",
    description: "トリガの出力です。"
  }
]} />

`*` には、シナリオのインデックスまたは[名前](/docs/use/scenario/types/#scenario-name)を指定します。
